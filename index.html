<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Alunos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table, th, td { border: 1px solid black; border-collapse: collapse; padding: 8px; }
        th { background-color: #f2f2f2; }
        button { padding: 5px 10px; margin: 5px; }
        #studentForm { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
        #studentForm label { display: block; margin: 5px 0; }
        #errorMessage { color: red; margin: 10px 0; }
        #successMessage { color: green; margin: 10px 0; }
        #loadingMessage { color: blue; }
    </style>
</head>
<body>
    <h1>Alunos</h1>
    <button id="addNewButton">Adicionar Novo Aluno</button>
    <div id="successMessage"></div>
    <div id="errorMessage"></div>
    <div id="loadingMessage">Carregando...</div>
    <table id="alunosTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome Completo</th>
                <th>Idade</th>
                <th>CPF</th>
                <th>Número Telefone</th>
                <th>Email</th>
                <th>Endereço</th>
                <th>Cidade</th>
                <th>Nome Instituição</th>
                <th>Curso</th>
                <th>Período</th>
                <th>Ganho Horas</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be inserted here via JavaScript -->
        </tbody>
    </table>
    <div id="studentForm" style="display: none;">
        <form>
            <input type="hidden" id="aluno_ID">
            <label>Nome Completo: <input type="text" id="nome_completo"></label>
            <label>Idade: <input type="number" id="idade"></label>
            <label>CPF: <input type="text" id="CPF"></label>
            <label>Número Telefone: <input type="text" id="numero_telefone"></label>
            <label>Email: <input type="email" id="email"></label>
            <label>Endereço: <input type="text" id="endereco"></label>
            <label>Cidade: <input type="text" id="cidade"></label>
            <label>Nome Instituição: <input type="text" id="nome_instituicao"></label>
            <label>Curso: <input type="text" id="curso"></label>
            <label>Período: <input type="text" id="periodo"></label>
            <label>Ganho Horas: <input type="number" id="ganho_horas"></label>
            <button type="button" id="saveButton">Salvar</button>
            <button type="button" id="cancelButton">Cancelar</button>
        </form>
    </div>
    <script>
        // Definir as credenciais
        const supabaseUrl = 'https://eygsxxhjxeugfhaysfjm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z3N4eGhqeGV1Z2ZoYXlzZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NDU5NDUsImV4cCI6MjA2MDMyMTk0NX0.s9gvt1cvo6fYtFNvj2o77-TGlRS2rIx6zoz-310cBhE';

        // Inicializar o cliente Supabase
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Função para formatar o número de telefone (remover caracteres não numéricos, apenas para padronização)
        function formatPhoneNumber(phone) {
            if (!phone) return null;
            return phone.replace(/\D/g, ''); // Remove tudo que não é dígito
        }

        async function fetchStudents() {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = '';
                const { data, error } = await supabaseClient.from('alunos').select('*');
                if (error) {
                    throw error;
                }
                const tableBody = document.getElementById('alunosTable').querySelector('tbody');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    document.getElementById('errorMessage').textContent = 'Nenhum aluno encontrado na tabela.';
                } else {
                    data.forEach(student => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.aluno_ID || ''}</td>
                            <td>${student.nome_completo || ''}</td>
                            <td>${student.idade || ''}</td>
                            <td>${student.CPF || ''}</td>
                            <td>${student.numero_telefone || ''}</td>
                            <td>${student.email || ''}</td>
                            <td>${student.endereco || ''}</td>
                            <td>${student.cidade || ''}</td>
                            <td>${student.nome_instituicao || ''}</td>
                            <td>${student.curso || ''}</td>
                            <td>${student.periodo || ''}</td>
                            <td>${student.ganho_horas || ''}</td>
                            <td>
                                <button onclick="editStudent(${student.aluno_ID})">Editar</button>
                                <button onclick="deleteStudent(${student.aluno_ID})">Excluir</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Erro ao buscar alunos:', error);
                document.getElementById('errorMessage').textContent = `Erro ao conectar com o Supabase: ${error.message}. Verifique a URL, a chave API ou o console para mais detalhes.`;
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
            }
        }

        function showForm(student = null) {
            const form = document.getElementById('studentForm');
            if (student) {
                document.getElementById('aluno_ID').value = student.aluno_ID || '';
                document.getElementById('nome_completo').value = student.nome_completo || '';
                document.getElementById('idade').value = student.idade || '';
                document.getElementById('CPF').value = student.CPF || '';
                document.getElementById('numero_telefone').value = student.numero_telefone || '';
                document.getElementById('email').value = student.email || '';
                document.getElementById('endereco').value = student.endereco || '';
                document.getElementById('cidade').value = student.cidade || '';
                document.getElementById('nome_instituicao').value = student.nome_instituicao || '';
                document.getElementById('curso').value = student.curso || '';
                document.getElementById('periodo').value = student.periodo || '';
                document.getElementById('ganho_horas').value = student.ganho_horas || '';
            } else {
                document.getElementById('aluno_ID').value = '';
                document.getElementById('nome_completo').value = '';
                document.getElementById('idade').value = '';
                document.getElementById('CPF').value = '';
                document.getElementById('numero_telefone').value = '';
                document.getElementById('email').value = '';
                document.getElementById('endereco').value = '';
                document.getElementById('cidade').value = '';
                document.getElementById('nome_instituicao').value = '';
                document.getElementById('curso').value = '';
                document.getElementById('periodo').value = '';
                document.getElementById('ganho_horas').value = '';
            }
            form.style.display = 'block';
        }

        async function editStudent(id) {
            try {
                const { data, error } = await supabaseClient.from('alunos').select('*').eq('aluno_ID', id);
                if (error) {
                    throw error;
                }
                if (data.length === 0) {
                    document.getElementById('errorMessage').textContent = `Nenhum aluno encontrado com ID ${id}.`;
                    return;
                }
                if (data.length > 1) {
                    document.getElementById('errorMessage').textContent = `Múltiplos alunos encontrados com ID ${id}. Por favor, verifique a unicidade do aluno_ID.`;
                    return;
                }
                showForm(data[0]);
            } catch (error) {
                console.error('Erro ao buscar aluno:', error);
                document.getElementById('errorMessage').textContent = `Erro ao buscar aluno para edição: ${error.message}`;
            }
        }

        async function deleteStudent(id) {
            if (confirm('Tem certeza que deseja excluir este aluno?')) {
                try {
                    const { error } = await supabaseClient.from('alunos').delete().eq('aluno_ID', id);
                    if (error) {
                        throw error;
                    }
                    fetchStudents(); // Atualiza a tabela após exclusão
                } catch (error) {
                    console.error('Erro ao excluir aluno:', error);
                    document.getElementById('errorMessage').textContent = `Erro ao excluir aluno: ${error.message}`;
                }
            }
        }

        async function saveStudent() {
            try {
                const id = document.getElementById('aluno_ID').value;
                const student = {
                    nome_completo: document.getElementById('nome_completo').value || null,
                    idade: document.getElementById('idade').value ? parseInt(document.getElementById('idade').value) : null,
                    CPF: document.getElementById('CPF').value || null,
                    numero_telefone: formatPhoneNumber(document.getElementById('numero_telefone').value),
                    email: document.getElementById('email').value || null,
                    endereco: document.getElementById('endereco').value || null,
                    cidade: document.getElementById('cidade').value || null,
                    nome_instituicao: document.getElementById('nome_instituicao').value || null,
                    curso: document.getElementById('curso').value || null,
                    periodo: document.getElementById('periodo').value || null,
                    ganho_horas: document.getElementById('ganho_horas').value ? parseInt(document.getElementById('ganho_horas').value) : null,
                };
                if (id) {
                    // Update: Não incluir aluno_ID no objeto student, pois é gerenciado pelo Supabase
                    const { error } = await supabaseClient.from('alunos').update(student).eq('aluno_ID', id).select();
                    if (error) {
                        throw error;
                    }
                } else {
                    // Insert: Não incluir aluno_ID no objeto student, permitindo que o Supabase gere automaticamente
                    const { error } = await supabaseClient.from('alunos').insert([student]).select();
                    if (error) {
                        throw error;
                    }
                }
                document.getElementById('studentForm').style.display = 'none';
                fetchStudents(); // Atualiza a tabela após salvar
            } catch (error) {
                console.error('Erro ao salvar aluno:', error);
                document.getElementById('errorMessage').textContent = `Erro ao salvar aluno: ${error.message}`;
            }
        }

        function initApp() {
            // Adicionar event listeners
            document.getElementById('addNewButton').addEventListener('click', () => {
                showForm();
            });

            document.getElementById('saveButton').addEventListener('click', saveStudent);

            document.getElementById('cancelButton').addEventListener('click', () => {
                document.getElementById('studentForm').style.display = 'none';
            });

            // Configurar subscrição em tempo real para atualizar a tabela automaticamente
            const channel = supabaseClient.channel('alunos-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'alunos' },
                    (payload) => {
                        console.log('Mudança detectada:', payload);
                        fetchStudents(); // Atualiza a tabela quando há mudanças
                    }
                )
                .subscribe((status) => {
                    console.log('Status da subscrição:', status);
                    if (status === 'SUBSCRIBED') {
                        document.getElementById('successMessage').textContent = 'Conexão em tempo real estabelecida!';
                    } else {
                        document.getElementById('errorMessage').textContent = 'Erro ao estabelecer conexão em tempo real.';
                    }
                });

            // Buscar alunos ao carregar a página
            fetchStudents();
        }

        // Garantir que o script do Supabase esteja carregado antes de executar a lógica
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>